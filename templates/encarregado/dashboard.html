{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    :root {
        --bg-light: #f8f9fc;
        --card-light: #ffffff;
        --text-light: #2c3e50;
        --bg-dark: #1a1e2b;
        --card-dark: #2d3349;
        --text-dark: #eaeef2;
        --primary: #4e73df;
        --success: #1cc88a;
        --warning: #f6c23e;
        --danger: #e74a3b;
        --info: #36b9cc;
    }
    body {
        background-color: var(--bg-light);
        color: var(--text-light);
        transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
        background-color: var(--bg-dark);
        color: var(--text-dark);
    }
    .sidebar {
        background-color: var(--card-light);
        transition: background-color 0.3s;
    }
    body.dark-mode .sidebar {
        background-color: var(--card-dark);
    }
    .card {
        background-color: var(--card-light);
        border: none;
        border-radius: 15px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: background-color 0.3s;
    }
    body.dark-mode .card {
        background-color: var(--card-dark);
        box-shadow: 0 0.15rem 1.75rem 0 rgba(0, 0, 0, 0.5);
    }
    .card-header {
        background-color: transparent;
        border-bottom: 1px solid rgba(0,0,0,0.125);
        font-weight: 600;
    }
    .gradient-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
    }
    .gradient-success {
        background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
        color: white;
    }
    .gradient-warning {
        background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
        color: white;
    }
    .gradient-danger {
        background: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);
        color: white;
    }
    .gradient-info {
        background: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
        color: white;
    }
    .kpi-card {
        transition: transform 0.2s;
    }
    .kpi-card:hover {
        transform: translateY(-5px);
    }
    .progress {
        height: 10px;
        border-radius: 5px;
    }
    .dark-mode-toggle {
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    .sidebar {
        min-height: 100vh;
        transition: all 0.3s;
    }
    .sidebar.collapsed {
        margin-left: -200px;
    }
    .main-content {
        transition: margin-left 0.3s;
    }
    .main-content.expanded {
        margin-left: 0;
    }
    .btn-toggle-sidebar {
        cursor: pointer;
    }
    .heatmap-cell {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        margin: 2px;
        display: inline-block;
        background-color: #e0e0e0;
    }
    .heatmap-cell[data-value="1"] { background-color: #b3d9ff; }
    .heatmap-cell[data-value="2"] { background-color: #80b3ff; }
    .heatmap-cell[data-value="3"] { background-color: #4d8cff; }
    .heatmap-cell[data-value="4"] { background-color: #1a66ff; }
    .heatmap-cell[data-value="5"] { background-color: #0040cc; }
</style>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-md-block sidebar" id="sidebar">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="overview">
                            <i class="bi bi-speedometer2"></i> Vis√£o Geral
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="chamadas">
                            <i class="bi bi-calendar-check"></i> Chamadas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="usuarios">
                            <i class="bi bi-people"></i> Usu√°rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="locais">
                            <i class="bi bi-geo-alt"></i> Locais
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="analytics">
                            <i class="bi bi-graph-up"></i> Analytics
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Conte√∫do principal -->
        <main class="col-md-10 ms-sm-auto px-md-4 main-content" id="mainContent">
            <!-- Bot√£o toggle sidebar -->
            <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
                <button class="btn btn-sm btn-outline-secondary btn-toggle-sidebar" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                <h1 class="h2">Dashboard encarregado-</h1>
                <div>
                    <span class="me-2">Modo escuro</span>
                    <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()">
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o Vis√£o Geral (overview) -->
            <div id="section-overview" class="content-section">
                <!-- KPIs -->
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card kpi-card gradient-primary">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-uppercase mb-1">Usu√°rios Ativos</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ usuarios_ativos }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-people fs-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card kpi-card gradient-success">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-uppercase mb-1">Presentes Hoje</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ total_presentes_hoje }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-check-circle fs-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card kpi-card gradient-warning">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-uppercase mb-1">Pendentes</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ usuarios_pendentes }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-exclamation-triangle fs-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card kpi-card gradient-danger">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-uppercase mb-1">Chamadas p/ Aprova√ß√£o</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ chamadas_pendentes_aprovacao }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-clock-history fs-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos e previs√µes -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-graph-up me-1"></i>
                                Tend√™ncia de Presen√ßas (√∫ltimos 30 dias)
                            </div>
                            <div class="card-body">
                                <canvas id="trendChart" width="400" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-pie-chart me-1"></i>
                                Distribui√ß√£o por Setor
                            </div>
                            <div class="card-body">
                                <canvas id="setorChart" width="200" height="200"></canvas>
                            </div>
                        </div>
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-calendar2-week me-1"></i>
                                Previs√£o para Amanh√£
                            </div>
                            <div class="card-body text-center">
                                <h1 class="display-4">{{ previsao }}</h1>
                                <p>presen√ßas esperadas</p>
                                <small>Baseado na m√©dia dos √∫ltimos 7 dias</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top funcion√°rios e chamadas pendentes -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-trophy me-1"></i>
                                Top 5 Funcion√°rios (√∫ltimos 30 dias)
                            </div>
                            <div class="card-body">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Funcion√°rio</th>
                                            <th>Presen√ßas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in top_funcionarios %}
                                        <tr>
                                            <td>{{ item.nome }}</td>
                                            <td>
                                                <div class="progress">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width: {% widthratio item.presencas 30 100 %}%;" aria-valuenow="{{ item.presencas }}" aria-valuemin="0" aria-valuemax="30">{{ item.presencas }}</div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="2">Nenhum dado</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-exclamation-circle me-1"></i>
                                Chamadas Pendentes
                            </div>
                            <div class="card-body">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Encarregado</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for chamada in chamadas_pendentes %}
                                        <tr>
                                            <td>{{ chamada.data|date:"d/m/Y" }}</td>
                                            <td>{{ chamada.encarregado.get_full_name|default:chamada.encarregado.username }}</td>
                                            <td>
                                                <a href="{% url 'gerente_chamada_detail' chamada.id %}" class="btn btn-sm btn-info">Detalhes</a>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="3">Nenhuma chamada pendente</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mapa de calor e timeline -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-grid-3x3-gap-fill me-1"></i>
                                Mapa de Calor de Presen√ßas (√∫ltimos 30 dias)
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Usu√°rio</th>
                                                {% for dia in dias_semana %}
                                                <th>{{ dia }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for linha in calor_data %}
                                            <tr>
                                                <td>{{ linha.nome }}</td>
                                                {% for valor in linha.dias %}
                                                <td>
                                                    <div class="heatmap-cell" data-value="{{ valor }}" title="{{ valor }} presen√ßas"></div>
                                                </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <small>Intensidade: 1 (mais claro) a 5+ (mais escuro)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-clock me-1"></i>
                                Timeline de Atividades
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    {% for atividade in atividades %}
                                    <li class="mb-2">
                                        <i class="bi bi-calendar-check me-2 text-primary"></i>
                                        {{ atividade.descricao }}
                                        <small class="text-muted d-block">{{ atividade.data|date:"d/m/Y H:i" }}</small>
                                    </li>
                                    {% empty %}
                                    <li>Nenhuma atividade recente</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <!-- Alertas inteligentes -->
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">
                                <i class="bi bi-bell me-1"></i>
                                Alertas
                            </div>
                            <div class="card-body">
                                {% if not chamada_hoje %}
                                <div class="alert alert-warning py-2">‚ö†Ô∏è Nenhuma chamada registrada hoje!</div>
                                {% endif %}
                                {% if usuarios_pendentes > 0 %}
                                <div class="alert alert-info py-2">üë• {{ usuarios_pendentes }} usu√°rio(s) aguardando aprova√ß√£o.</div>
                                {% endif %}
                                {% if chamadas_pendentes_aprovacao > 0 %}
                                <div class="alert alert-danger py-2">‚è≥ {{ chamadas_pendentes_aprovacao }} chamada(s) pendente(s) de aprova√ß√£o.</div>
                                {% endif %}
                                {% if frequencia_media < 70 %}
                                <div class="alert alert-secondary py-2">üìâ Frequ√™ncia m√©dia baixa ({{ frequencia_media }}%).</div>
                                {% endif %}
                            </div>-
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outras se√ß√µes (Chamadas, Usu√°rios, Locais) seriam similares aos templates antigos, mas por brevidade omiti -->
            <div id="section-chamadas" class="content-section" style="display: none;">
                <h2>Chamadas</h2>
                <!-- Colocar a lista de chamadas aqui (copiado do template antigo) -->
            </div>
            <div id="section-usuarios" class="content-section" style="display: none;">
                <h2>Usu√°rios</h2>
                <!-- Colocar a lista de usu√°rios aqui -->
            </div>
            <div id="section-locais" class="content-section" style="display: none;">
                <h2>Locais</h2>
                <!-- Colocar a lista de locais aqui -->
            </div>
            <div id="section-analytics" class="content-section" style="display: none;">
                <h2>Analytics Avan√ßado</h2>
                <p>Aqui poderiam vir mais gr√°ficos e previs√µes.</p>
            </div>
        </main>
    </div>
</div>

<!-- Bot√£o dark mode flutuante (opcional) -->
<div class="dark-mode-toggle" onclick="toggleDarkMode()">
    <i class="bi bi-moon-fill"></i>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dados passados do Django
const datas = {{ datas|safe }};
const presencasDia = {{ presencas_dia|safe }};
const setores = {{ setores|safe }};

// Gr√°fico de tend√™ncia
const ctxTrend = document.getElementById('trendChart').getContext('2d');
new Chart(ctxTrend, {
    type: 'line',
    data: {
        labels: datas,
        datasets: [{
            label: 'Presen√ßas',
            data: presencasDia,
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
    }
});

// Gr√°fico de setores
const ctxSetor = document.getElementById('setorChart').getContext('2d');
new Chart(ctxSetor, {
    type: 'doughnut',
    data: {
        labels: setores.map(s => s.nome),
        datasets: [{
            data: setores.map(s => s.total),
            backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});

// Fun√ß√£o para alternar sidebar
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('collapsed');
    document.getElementById('mainContent').classList.toggle('expanded');
}

// Fun√ß√£o para alternar modo escuro
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
    document.querySelector('.dark-mode-toggle i').className = isDark ? 'bi bi-brightness-high-fill' : 'bi bi-moon-fill';
}

// Carregar prefer√™ncia do modo escuro
if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
    document.querySelector('.dark-mode-toggle i').className = 'bi bi-brightness-high-fill';
}

// Navega√ß√£o por se√ß√µes (simples)
document.querySelectorAll('.sidebar .nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.getAttribute('data-section');
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById('section-' + sectionId).style.display = 'block';
        document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
    });
});

// Heatmap coloring
document.querySelectorAll('.heatmap-cell').forEach(cell => {
    const value = parseInt(cell.getAttribute('data-value'));
    if (value >= 5) cell.style.backgroundColor = '#0040cc';
    else if (value >= 4) cell.style.backgroundColor = '#1a66ff';
    else if (value >= 3) cell.style.backgroundColor = '#4d8cff';
    else if (value >= 2) cell.style.backgroundColor = '#80b3ff';
    else if (value >= 1) cell.style.backgroundColor = '#b3d9ff';
    else cell.style.backgroundColor = '#e0e0e0';
});
</script>
{% endblock %}